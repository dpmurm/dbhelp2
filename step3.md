# Шаг 3 : Что такое MVC?

Рамки MVC весьма размыты, поэтому моё понимание может не совпадать с полученными вами ранее знаниями. Хотел бы напомнить что все сказанное в уроке является моим личным опытом, и я не навязываю вам думать точно также. Такой материал весьма тяжело рассказывать, поэтому прошу отнестись с пониманием. И так, начнем урок...

Введение

Model-view-controller или просто MVC  — это шаблон проектирования приложения. Он применятся как в web разработке, так и в обычном прикладном программировании. Выбор данной архитектуры подразумевает разделение приложения на три логические части (компоненты), каждая из которых выполняет определенный ряд своих функций.

Большая гибкость приложения на MVC и является самым главным плюсом к его использованию. Для себя я отметил следующие вещи:

    Вы можете изменять один компонент приложения при минимальном воздействии на другие.
    Все таблицы, html код, да и вообще вся верстка — теперь в отдельных файлах. Тонны php кода не будут мешаться с html (превращая приложения в кучу мусора).
    Исходя из пункта «два» -  верстальщики начнут вас уважать и благодарить :) Также вы с лёгкостью сможете подключить к приложению шаблонизатор (Smarty или др).
    У вас получиться во много раз уменьшить повторение кода

Yii Framework Blog img http://dbhelp.ruyii-poweredКонечно если есть «плюсы», то и есть «минусы». В принципе «минусы» можно найти в чем угодно, поэтому обвинения что «MVC приложение работает медленнее чем приложение на чистом php» — я не рассматриваю. Понимаете, за счет небольшого (именно небольшого) убытка в скорости, вы получаете приложение которое и через десять лет будет легко расширять (что не всегда можно сказать про крупный сайт на чистом php).
Э..?

Yii Framework Blog img http://dbhelp.ruhelloworld Давайте поговорим всё таки за счет чего достигаются все эти плюсы. Как я уже и говорил, приложение разбивается на три части. Рассмотрим подробнее что и для чего:
Контроллер (Controller)

В Yii контроллером называется класс наследуемый от CController или дочернего от него. Сам контроллер у нас занимается следующими действиями:

    Обрабатывает данные которые пришли от пользователя (GET, POST запросы)
    Содержит в себе общую логику приложения (проверки, анализ, редиректы). Проверяет имеет ли пользователь доступ к данному куску приложения и тп.
    Говорит где и что должно быть показано пользователю, но сам ничего не выводит! Те. просто вызывает в нужном месте нужные нам отображения
    Обращается к модели если надо получить какие то данные (например из базы)

Все данные которые пользователь указывает в адресной строке — попадают на обработку к контроллеру. Если вы не меняли маршруты-по-умолчанию у себя на сайте, то написав localhost/site/ - пользователь обратится к контроллеру Site.

Заметка : В приложении может быть как один контроллер, так и несколько. 

Внутри класса контроллера должны находиться экшинсы которые отвечают за отдельные части приложения. Экшинсы (Actions) — это простые методы, которые имеют приставку «action» перед своим именем.

Вот так выглядит простой контроллер Site с двумя экшинсами:

<?php
// После имени контроллера - обязательно приставка Controller!
// т.е. вместо Site - пишем SiteController. Также наш контроллер
// обязательно должен быть наследован от класса CController
// или дочернего от него
class SiteController extends CController
{
    // перед названием экшинса вы должны написать приставку action,
    // после этого названиея (с большой буквы). 
    public function actionIndex()
    {
    }
    public function actionAuthor()
    {
    }
}

Важно запомнить:

    все экшинсы должны начинаться с приставки «action»
    все контроллеры должны после имени иметь приставку «Controller»
    не забывайте наследовать свой контроллер от CController или дочернего от него класса.

Давайте теперь разберем для чего нам экшинсы.

Когда вы набрали в браузере : localhost/site/index/ - вы обратились к контроллеру Site и его экшинсу index (actionIndex). В данном случае весь код который будет внутри экшинса (к которому мы обращаемся) — будет выполнен.

Теперь давайте немного модернизируем наш код:

    public function actionIndex()
    {
        die ("Привет! Это actionIndex()");
    }
    public function actionAuthor()
    {
        die ("Привет! Это actionAuthor()");
    }

Когда мы обратимся к нашему приложению по адресу localhost/site/index/ мы получим на экране надпись:

Привет! Это actionIndex()

А если наберем localhost/site/author/ :

Привет! Это actionAuthor()

Заметка: Функция die() в php — аналогична функции echo. Единственное отличие в том что после вывода  — приложение дальше не выполняется. 

Как вы понимаете благодаря такой разбивке контроллеров вы можете легко планировать страницы внутри своего приложения.

Также хочу добавить, что написав localhost/site/author/?test=hello_world — вы также как и раньше обратитесь к экшинсу author, но на этот раз в нем будет доступна переменная $_GET['test'] со значением «hello_world».

Заметка: Для того что бы использовать красивые адреса вида localhost/site/author/2007/09/01/ и т.п. — надо использовать маршруты! Рассматривать данный материал мы будем отдельно, не в этом уроке!

Обычно все контроллеры приложения в Yii располагаются по адресу protected/controllers/. Имя контроллера также должно иметь приставку Controller. К примеру, если вы хотите что бы по адресу localhost/user/index/ выводился текст «Привет Вася!», вы должны выполнить следующие действия:

    В папке protected/controllers/ создать файл UserController.php
    В нем разместить следующий код:

    <?php
    class UserController extends CController
    {
        public function actionIndex()
        {
            die ("Привет Вася!");
        }
    }

    Набрать в браузере localhost/user/index/ или localhost/user/

Заметка: Хочу отметить что за вывод страницы localhost/ также отвечает контроллер. (Да, он не указан в адресе после localhost, но он все равно есть). В Yii конфиге вы можете указать какой контроллер будет выполняться «по умолчанию» (обычно это SiteController)

Модель (Model)

Модель это класс для работы приложения с базой. Для каждой таблицы с которой предстоит работать — создается своя модель (в Yii это класс наследуемый от CModel или производного от него).

Модель в нашем приложении выполняет следующие действия:

    Облегчает работу с данными в базе (при наследовании от CActiveRecord или производного от него)
    Проверка данных перед сохранением/добавлением согласно правилам (rules)
    Содержит в себе пользовательские методы для более продвинутой работы с базой

Самая простая модель выглядит следующим образом:

<?php
// Наследуем нашу модель от CActiveRecord
class Users extends CActiveRecord
{        
    public static function model($className=__CLASS__)
    {
        return parent::model($className);
    }
    /**
     * Специально что бы указать с какой таблицей
     * в базе данных работает наша модель.
     *
     * @return unknown
     */
    public function tableName()
    {
        // в нашем случае это таблица user
        return 'user';
    }
}

Заметка: Вы можете спокойно использовать данный каркас у себя в работе (изменяя лишь название класса и таблицу с которой работает модель).

Перед нами модель для работы с пользователями (с таблицей user). Благодаря тому что мы наследуем её от класса CActiveRecord — мы получаем дополнительный функционал (методы find, count, findAll и др.)

Для того что бы обратиться к модели из контроллера необходимо написать:

Название_модели::model()->название_метода();

Либо предварительно создав экземпляр модели:

$model = new Название_модели();
$model->название_метода();

Заметка: В отличии от контроллера после названия класса модели — приставок писать не надо. Мы можем называть наши модели как хотим. Файл модели обычно располагается в папке protected/models и совпадает с названием класса. 

Посмотрите как просто выглядит запрос для получения пользователя с логином - «zolter»:

$user_info = User::model()->findByAttributes(array('login' => 'zolter'));

В данном примере я использовал встроенный метод  findByAttributes в котором указал что необходимо найти запись где поле «login» равняется значению «zolter». Если такая запись в таблице users существует — в переменной $user_info будет сохранен результат (обьект).

Получить доступ к его полям вы можете следующим образом:

echo $user_info->login; // получу логин (zolter)
echo $user_info->id; // получу id

Заметка: Встроенных методов достаточно много. Более подробно они будут описаны в «Шаг 4: Модель». Самую полную информацию по всем методам вы можете получить в API (http://www.yiiframework.com/doc/api/CActiveRecord) [англ] или статье «Active Record» [рус.] (http://www.yiiframework.ru/doc/guide/ru/database.ar)

Если вам не хватает встроенных методов модели — вы можете легко расширить их. Для этого просто добавьте новый метод в свою модель и обращайтесь к нему аналогичным образом.

Заметка: Для каждой таблицы с которой работает приложение должна быть создана соответствующая модель.

Отображение (View)

Главной функцией отображения является вывод данных (которые возможно пришли из контроллера) на экран. Обычно файл отображения содержит в себе элементы пользовательского интерфейса. В нем также допускается использование php для реализации простой-логики. К примеру, выставления проверок: «если пользователь имеет статус админ — тогда выводим этот кусок файла, иначе — другой». Следуя требованиям MVC в отображении должен находиться минимум кода логики приложения (для этого специально существует контроллер).

Заметка: В некоторой документации View называют «отображением», в некоторой — «представлением». Мне больше нравиться первый вариант. 

Вот пример простого отображения, которое служит для вывода меню на сайте:

<h1>меню</h1>
<a href='#'>пункт 1</a> 
<a href='#'>пункт 2</a> 
<?php if ($user['status'] == «admin»): ?>
     <a href='#'>меню админа</a>
<?php endif; ?>

Как вы видите это простой html код. Ничего сложного! В нем также я влепил проверку "является ли пользователь админом" (если да — тогда выводим дополнительный пункт меню).

Переменная $user может быть объявлена в этом же отображении, а может быть передана с контроллера.

Заметка: для того чтобы вывести отображение из контроллера — используется метод render(«название_отображения»). По умолчанию будет выведено на экран отображение с переданным названием, из папки : views/название_контроллера/название_отображения/

Если в контроллере Test написать $this->render('my_view_file') — файл отображения будет подгружаться из адреса protected/views/test/my_view_file/. Поэтому обычно для каждого контроллера в папке views создается своя папка, со своими отображениями.
Давайте используя уже полученные ранее знания, решим следующую задачу:

Пускай у нас есть таблица users (с полями: id, login, passwd). Зайдя по адресу localhost/admin/index/ на экране должна быть показана информация о пользователе с логином "admin".

Создаем модель для работы с таблицей users. Назавём её User.php и поместим по адресу protected/models:

<?php
class User extends CActiveRecord
{        
    public static function model($className=__CLASS__)
    {
        return parent::model($className);
    }
    public function tableName()
    {
        // в нашем случае это таблица users
        return 'users';
    }
}

Теперь создадим контроллер который используя модель — получит данные пользователя «admin», и передаст их в отображение. Контроллер создаем в папке protected/controllers и называем AdminController.php :

<?php
class AdminController extends CController
{
    public function actionIndex()
    {
        // Проверяем есть ли такой пользователь в базе.
        // Если есть - сохраняем его данные в $user_info
        if ($user_info = User::model()->findByAttributes(array('login' => 'zolter'))) {
            $this->render('index', array(
                // передаем параметнную $user_info в отображение
                // в котором она будет доступна по имени - "$info"
                'info'    =>    $user_info,
            ));
        } else {
            die('нет такого юзера');            
        }
    }
}

Ну и осталось дело за малым, создаем отображением. Для этого в папке views создаем папку admin (согласно названию нашего контроллера). Теперь в папке admin создаем файл index.php (согласно названию экшинса который его вызывает) :

<pre>
     Id : <?php echo $info->id; ?>
     Логин: <?php echo $info->login; ?> 
     Пароль: <?php echo $info->passwd; ?>
</pre>

При запуске localhost/admin/index вы должны увидеть на экране логин, пароль и id админа. (если не забыли предварительно создать его в таблице users).

Как это работает?

    Вы набрали localhost/admin/index тем самым обратились в контроллер Admin, и экшинс Index
    Далее начал работать код из actionIndex()
    Вы запросили из модели User данные, где логин равен значению «zolter». Т.к. Модель User связана с таблицей users — она сделала запрос в БД к этой таблице.
    После того как такие данные были найдены — методом render они были переданы в отображение index.php
    После этого на экран было показано отображением

Вывод..

Я не ставил перед собой цель описать весь функционал и возможности контроллера-модели-отображения. Надеюсь тем кто не понимал что такое MVC — стало немного понятнее.

Писал в спешке, надеюсь ничего не забыл. Если встретите ошибки в тексте — выделяйте их через Ctrl+Enter (буду очень благодарен).
