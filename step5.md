Шаг 5 : Контроллер

Давайте сегодня поговорим что же такое “контроллер” и для чего он используется в приложениях на базе MVC
---

В уроке номер три вы должны были познакомится с кратким описанием что такое контроллер и какие основные функции он выполняет. Для тех кто уже забыл - повторим в более расширенной форме. В Yii фреймворке контроллером считается класс наследуемый от CController или дочернего от него класса.

В этом уроке у нас будет много примеров работы с контроллером, поэтому давайте договоримся что вы не только читаете урок, но и параллельно выполняете его примеры у себя на хостинге (или локалхосте). Самое удобное будет если вы установите yii-blog из официальной документации (http://www.yiiframework.com/doc/blog/ru/start.overview).

Вот как делаю это я:

    Зайди на страницу “Download” (http://www.yiiframework.com/download/) и выкачай последнюю версию фреймворка
    Распакуй. Залей к себе на хостинг
    Войди в папку demo/blog. Скопируй все что там внутри и перемести в корневую папку что бы получилось что папка protected и yii-1.1.2.rN теперь на одном уровне.
    Открой index.php и измени пути к папке фреймворка и конфиг файла
    Заходи к себе через www.mysite.ru и проверь работает ли блог


Больше не какой настройкой заниматься не надо, работает и хорошо. Идем дальше.

Что бы разобраться для чего в приложении использовать контроллер давайте разберем совсем маленький пример приложения на Yii.  

Пример 1


В Yii есть отличный класс CUrlManager который отвечает за обработку url по которому обратились к нашему приложению. Зайдя по ссылке www.mysite.ru/hello/world сразу начнет работу CUrlManager и определит куда дальше передать запрос на обработку.

Правила обработки url задаются в главном конфиг файле приложения (обычно protected/config/main.php) и могут быть дополнены или изменены вами в любой момент. По умолчанию забито самое главное правило вашего приложения:

'<controller:\w+>/<action:\w+>'=>'<controller>/<action>',



Которое говорит о том что первый параметр в url это название контроллера <controller>, а второй это один из его методов <action>. Поэтому при обращении по ссылке  www.mysite.ru/hello/world за отображение страницы на экране будет отвечать контроллер Hello и его метод actionWorld. Смелее, пробуйте проделать это у себя в приложении. Увидели ошибку? это говорит об отсутствии класса (контроллера) к которому мы пробуем обратится. Создадим?

Открываем папку protected/controllers и создаем там файлик HelloController.php:

<?php
class HelloController extends CController
{
   public function actionWorld()
   {
       echo 'Привет от HelloController->actionWorld()';
   }
}



Теперь набрав в браузере www.mysite.ru/hello/world мы получим надпись “Привет от HelloController->actionWorld()”. По аналогии вы можете добавить в этом контроллере еще пару экшинов и убедится что все работает как надо:

<?php
class HelloController extends CController
{
   public function actionWorld()
   {
       echo 'Привет от HelloController->actionWorld()';
   }
   public function actionStepan()
   {
       echo 'Привет Степан!';
   }
   public function actionDima()
   {
       echo 'Привет Дима!';
   }
   public function actionIvan()
   {
       echo 'Привет Иван!';
   }
}



Пробуй теперь: www.mysite.ru/hello/dima, www.mysite.ru/hello/ivan, www.mysite.ru/hello/stepan. Работает? Еще бы!


Идем дальше...


В каждом приложении существует такое понятие как контроллер “по умолчанию”. Он используется для обработки url когда параметр контроллера опущен совсем. К примеру, при попытке пользователя открыть www.mysite.ru/ какой контроллер будет отвечать за отображение страницы? Правильно, контроллер по умолчанию.

прим. Контроллер по умолчанию задается в файле конфигурации приложения (обычно config/main.php) в виде парраметра defaultController, например: 'defaultController'=>'index'. Если параметр не указан, контроллер по умолчанию - site

Существует еще понятие как экшин “по умолчанию”. Он выполняется в том случае когда не указанно явно к какому экшину идет обращение. К примеру, при попытке открыть www.mysite.ru/hello/ как скрипту узнать к какому экшину контроллера Hello происходит обращение? В этом случае и будет вызван экшин по умолчанию!

прим. Экшин по умолчанию задается прямо в файле контроллера в виде переменной defaultAction, например $defaultAction = ‘test’. Если параметр не указан, экшин по умолчанию - index

Пример 2


Посмотрели вы что я написал и подумали : “Если для каждой страницы создавать свой экшин - тогда как быть с новостями на сайте? Забивать их в ручную и создавать для каждой свой экшин? Бреееддд”. Совершенно верно подумали :) Совсем не обязательно создавать новый экшин для каждой страницы ваших новостей.

Давайте предположим что мы хотим организовать специальные новости для своего сайта. Для начала откроем контроллер с которым мы уже работали (HelloController) и добавим туда новый экшин:

  public function actionNews()
  {
      echo “Вы открыли новость: ” , $_GET['news_name'];
  }



Все достаточно просто, обычный экшин который выводит на экран значение переменной ‘news_name’. Попробуйте, должно работать - www.mysite.ru/hello/news/?news_name=Тестовая_новость. Работает? Отлично!

На этом можно было бы и остановится, да только не красивый у нас адрес новости получается. Давайте откроем конфигурационный файл (config/main.php) и добавим туда специальное правило для новостей! Найдите блок urlManager, он должен выглядеть у вас следующим образом:

'urlManager'=>array(
   'urlFormat'=>'path',
   'rules'=>array(
       'post/<id:\d+>/<title:.*?>'=>'post/view',
       'posts/<tag:.*?>'=>'post/index',
       '<controller:\w+>/<action:\w+>'=>'<controller>/<action>',
   ),
),



Первые два правила - используются нашим блог движком, нам их рассматривать не интересно. Третье правило мы рассмотрели выше и знаем для чего оно используется.

Давайте добавим свое правило по типу тех что мы видим:

'news/<news_name:.*?>'=>'hello/news

Я хочу быть точно уверен что вы поняли что это значит, и хочу объяснить все подробно:

    'news/<news_name:.*?>'=>'hello/news' - правило применяется только к url адресам которые начинаются на словое news, например: www.mysite.ru/news/123123 и www.mysite.ru/news/555555
    'news/<news_name:.*?>'=>'hello/news' - говорит о том, что после слова “news” обязательно должен идти следующий параметр. В экшин этот параметр будет доступен как $_GET[‘news_name’ ]
    'news/<news_name:.*?>'=>'hello/news' - проверка на тип переменной. В данном случае мы используем “*” (звездочку) говоря о том что тип не имеет значения. Если бы требовалось что б правило срабатывало только когда news_name - число, тогда мы написали бы <news_name:.\d+>
    'news/<news_name:.*?>'=>'hello/news' - указываем какой контроллер и экшин будет заниматся обработкой этого правила. В данном случае все запросы будут отправлены в контроллер Hello и его экшин News.


Надеюсь это всем стало понятно т.к. использование собственных правил в приложении очень важный момент.

Попробуйте теперь открыть страницу www.mysite.ru/news/Вторая_тестовая_новость. Надеюсь для вас не было неожиданностью что вы увидели на экране надпись “Вы открыли новость: Вторая тестовая новость”? Если все еще не понятно откуда это взялось - просмотрите ваш HelloController.

 

Идем дальше...


Контроллер сам по себе это сердце логики вашего приложения. В нем вы должны выполнять всякие проверки, обращение к данным из модели и тп. Я мог бы растянуть урок рассказами о том как использовать собственные фильтры в контроллерах, как наследовать их и тп - но все это только запудрит вам голову. Если вы действительно поймете для чего нужен контроллер - вы сможете дойти до всяких “фильтров” сами, прочитав маленький мануальчик.

Поэтому не будем распылятся, а продолжим дальше осознавать для чего нам контроллер и как его использовать.

Из примера 2 у нас уже есть некий набросок для страницы новостей. У нас работают ссылки www.mysite.ru/news/my_test_news и мы можем перейти к следующему этапу разработки.

Пример 3


Давайте немного модернизируем наши новости. Задание достаточное простое: новости у нас находятся в тестовых файлах, а параметр news_name является этим самым именем файла. Открыв страницу www.mysite.ru/news/numb1 на странице должно выводится содержимое файла numb1.txt соответственно.
Модернизируем немного наш экшин:

   function actionNews()
   {
       if (!empty($_GET['news_name'])) {
           // если значение не пустое...
           // выводим содержимое переданного файла с расширением txt
           echo file_get_contents($_GET['news_name'] . ".txt");
       }
   }



Создаем фалик test.txt в главной директории (на уровне с index.php) и заполняем его текстом “привет это файл test.txt”. Теперь пробуем открыть www.mysite.ru/test и если получаем на экран наш текст - значит все работает.

прим. если ругается что файл не найден - скорее всего следует указать полный путь где его искать. такая ошибка может возникнуть из-за специфической настройки php/apache

Для большей красоты можно сделать проверку на существование файла и если его нет - выводить ошибку что новость уже удалена:

   function actionNews()
   {
       if (!empty($_GET['news_name'])) {
           // если значение не пустое...
           // загоняем в переменную имя файла который надо открыть
           $file_name = $_GET['news_name'] . ".txt";
           if (file_exists($file_name)) {
               // если файл существует
               // выводим на экран его содержимое
               echo file_get_contents($file_name);
           } else {
               // если файл не найден
               echo 'Новость уже удалили :(';
           }
       }
   }



На самом деле использовать такой подход у себя на сайте я настоятельно не рекомендую. Если злоумышленник допрет что вы загружаете новости из файлов, то сразу воспользуется уязвимостью и попробует манипулируя переменной news_name открыть файлы совершенно не относящиеся к новостям (к примеру, www.mysite.ru/news/\/..\/etc/htpasswd и тп). Так что данный пример я привел только что бы показать вам как работать с контроллером. Идеальным вариантом было бы загружать новости из базы данных при помощи модели!


Идем дальше...


Я надеюсь все эти примеры помогли вам еще лучше понять как можно использовать контроллеры у вас в приложениях. Уроки у нас для новичков и нет смысли пихать в вас полностью все что я знаю за один раз. Иначе моя писанина с трудом вмещалась бы на рулоне туалетной бумаги :)

Для написания следующей части урока мне потребуется немного времени и пока я буду этим занят вы выполните мое маленькое задание. Нет, писать сайты вместо меня и заниматься другой грязной работой не потребуется :)) Я предлагаю вам модернизировать наш “Пример 3” и вместо открытия новостей из файлов - постараться получить данные из БД. Помните, в прошлом уроке мы уже научились получать данные из базы методами find и findAll? Постарайтесь выполнить это самостоятельно для закрепления материала по контроллерам.  

Вот маленькая подсказка от меня:

    Создаем таблицу в базе данных для наших новостей (через phpmyadmin). Для начала всего три поля: id, url_name,text
    Создаем файл модели
    Изменяем наш экшин таким образом что б он брал данные из нашей модели где url_name = news_name
    Делаем что б если новость найдена - поле text выводилось на экран

 
От себя


Спасибо что прочитали все это! Желаю вам сил и терпения в изучении Yii Framework.
